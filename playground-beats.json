{
  "$schema": "https://playground.wordpress.net/blueprint-schema.json",
  "landingPage": "/",
  "preferredVersions": {
    "php": "8.2",
    "wp": "6.8"
  },
  "steps": [
    {
      "step": "unzip",
      "zipFile": {
        "resource": "url",
        "url": "https://raw.githubusercontent.com/crystalthedeveloper/wordpress-beats-playground/main/assets/beats-upload-player.zip",
        "caption": "Bundling Beats Upload Player"
      },
      "extractToPath": "/wordpress/wp-content/plugins/"
    },
    {
      "step": "defineWpConfigConsts",
      "consts": {
        "WP_ENVIRONMENT_TYPE": "playground",
        "WP_PLAYGROUND": true,
        "IS_PLAYGROUND": true
      }
    },
    {
      "step": "activatePlugin",
      "pluginPath": "beats-upload-player/beats-upload-player.php"
    },
    {
      "step": "activateTheme",
      "themeFolderName": "twentytwentyfive"
    },
    {
      "step": "runPHP",
      "code": "require_once ABSPATH . 'wp-admin/includes/post.php';\nrequire_once ABSPATH . 'wp-admin/includes/theme.php';\nrequire_once ABSPATH . 'wp-admin/includes/template.php';\n\nerror_log('[Beats Blueprint] runPHP start');\n$theme = wp_get_theme();\n$theme_slug = $theme->get_stylesheet();\nerror_log('[Beats Blueprint] theme stylesheet: ' . $theme_slug);\nerror_log('[Beats Blueprint] show_on_front before: ' . var_export(get_option('show_on_front', 'unset'), true));\nerror_log('[Beats Blueprint] page_on_front before: ' . var_export(get_option('page_on_front', 'unset'), true));\n\nif ( function_exists( 'beats_prime_data' ) ) {\n    beats_prime_data();\n    error_log('[Beats Blueprint] beats_prime_data executed');\n} elseif ( function_exists( 'beats_seed_playground_demo' ) ) {\n    beats_seed_playground_demo();\n    error_log('[Beats Blueprint] beats_seed_playground_demo executed');\n} else {\n    error_log('[Beats Blueprint] no seeding function available');\n}\n\nif ( ! function_exists( 'beats_filter_navigation_html' ) ) {\n    function beats_filter_navigation_html( $html ) {\n        if ( empty( $html ) ) {\n            return $html;\n        }\n\n        $home_url    = esc_url( home_url( '/' ) );\n        $home_url_no = untrailingslashit( $home_url );\n\n        $html = preg_replace(\n            '/<li[^>]*>\\s*<a[^>]*>\\s*beats\\s+demo\\s*<\\/a>\\s*<\\/li>/i',\n            '',\n            $html\n        );\n\n        $home_replaced = false;\n\n        $html = preg_replace_callback(\n            '/<a([^>]*)>(.*?)<\\/a>/is',\n            function( $matches ) use ( $home_url, $home_url_no, &$home_replaced ) {\n                $attrs = $matches[1];\n                $text  = trim( wp_strip_all_tags( $matches[2] ) );\n                $href  = '';\n\n                if ( preg_match( '/href\\s*=\\s*\"([^\"]*)\"/i', $attrs, $href_match ) ) {\n                    $href = untrailingslashit( trim( $href_match[1] ) );\n                }\n\n                if ( $home_replaced ) {\n                    return $matches[0];\n                }\n\n                if ( ! $href || $href === $home_url_no || in_array( strtolower( $text ), array( 'home', 'my wordpress website' ), true ) ) {\n                    $home_replaced = true;\n\n                    if ( preg_match( '/href\\s*=\\s*\"([^\"]*)\"/i', $attrs ) ) {\n                        $attrs = preg_replace( '/href\\s*=\\s*\"([^\"]*)\"/i', 'href=\"' . esc_url( $home_url ) . '\"', $attrs, 1 );\n                    } else {\n                        $attrs .= ' href=\"' . esc_url( $home_url ) . '\"';\n                    }\n\n                    return '<a' . $attrs . '>Beats</a>';\n                }\n\n                return $matches[0];\n            },\n            $html\n        );\n\n        if ( ! $home_replaced ) {\n            $beats_item = '<li class=\"wp-block-navigation-item\"><a href=\"' . $home_url . '\">Beats</a></li>';\n            if ( strpos( $html, '</ul>' ) !== false ) {\n                $html = preg_replace( '/<\\/ul>/i', $beats_item . '</ul>', $html, 1 );\n            } else {\n                $html = $beats_item . $html;\n            }\n        }\n\n        return $html;\n    }\n}\n\n$header_template = <<<HTML\n<!-- wp:group {\"align\":\"full\",\"style\":{\"spacing\":{\"padding\":{\"top\":\"20px\",\"bottom\":\"20px\",\"right\":\"24px\",\"left\":\"24px\"}}},\"layout\":{\"type\":\"flex\",\"justifyContent\":\"space-between\",\"flexWrap\":\"wrap\"}} -->\n<div class=\"wp-block-group alignfull\" style=\"padding-top:20px;padding-right:24px;padding-bottom:20px;padding-left:24px\">\n<!-- wp:site-title {\"level\":0,\"style\":{\"typography\":{\"fontWeight\":\"900\"}}} /-->\n<!-- wp:navigation {\"layout\":{\"type\":\"flex\",\"justifyContent\":\"right\",\"flexWrap\":\"wrap\"},\"overlayMenu\":\"never\"} -->\n<!-- wp:navigation-link {\"label\":\"Beats\",\"url\":\"%1$s\",\"kind\":\"custom\"} /-->\n<!-- wp:navigation-link {\"label\":\"Upload\",\"url\":\"%2$s\",\"kind\":\"post-type\",\"type\":\"page\"} /-->\n<!-- /wp:navigation -->\n</div>\n<!-- /wp:group -->\nHTML;\n\n$header_content = sprintf( $header_template, esc_url( home_url( '/' ) ), esc_url( home_url( '/upload/' ) ) );\n$header_slug    = sprintf( '%s//header', $theme_slug );\n\n$header_args = array(\n    'post_title'   => 'Header',\n    'post_name'    => $header_slug,\n    'post_status'  => 'publish',\n    'post_type'    => 'wp_template_part',\n    'post_content' => $header_content,\n    'tax_input'    => array(\n        'wp_theme' => array( $theme_slug ),\n    ),\n    'meta_input'   => array(\n        'origin' => 'beats-blueprint'\n    ),\n);\n\n$existing_header = get_page_by_path( $header_slug, OBJECT, 'wp_template_part' );\nif ( $existing_header ) {\n    $header_args['ID'] = $existing_header->ID;\n    $header_id         = wp_update_post( $header_args );\n} else {\n    $header_id = wp_insert_post( $header_args );\n}\n\nif ( ! is_wp_error( $header_id ) ) {\n    wp_set_post_terms( $header_id, $theme_slug, 'wp_theme' );\n    error_log('[Beats Blueprint] Header template part saved with ID ' . $header_id );\n} else {\n    error_log('[Beats Blueprint] Failed to save header template: ' . $header_id->get_error_message());\n}\n\n$beats_content = <<<HTML\n<!-- wp:group {\"tagName\":\"main\",\"align\":\"full\",\"style\":{\"spacing\":{\"padding\":{\"top\":\"30px\",\"right\":\"20px\",\"bottom\":\"40px\",\"left\":\"20px\"}}}} -->\n<main class=\"wp-block-group alignfull\" style=\"padding-top:30px;padding-right:20px;padding-bottom:40px;padding-left:20px\">\n<!-- wp:group {\"align\":\"full\",\"anchor\":\"beats-wrapper\",\"style\":{\"spacing\":{\"blockGap\":\"18px\",\"margin\":{\"top\":\"0\",\"bottom\":\"0\"},\"padding\":{\"top\":\"24px\",\"right\":\"24px\",\"bottom\":\"24px\",\"left\":\"24px\"}},\"border\":{\"radius\":\"16px\"}},\"layout\":{\"type\":\"constrained\"}} -->\n<div class=\"wp-block-group alignfull\" id=\"beats-wrapper\" style=\"border:none;border-radius:16px;margin-top:0;margin-bottom:0;padding-top:24px;padding-right:24px;padding-bottom:24px;padding-left:24px\">\n<!-- wp:paragraph {\"align\":\"center\"} -->\n<p class=\"has-text-align-center\">Preview the Beats library and player below.</p>\n<!-- /wp:paragraph -->\n<!-- wp:shortcode -->[beats_cltd_category_search]<!-- /wp:shortcode -->\n<!-- wp:group {\"align\":\"full\",\"style\":{\"spacing\":{\"blockGap\":\"16px\"}},\"layout\":{\"type\":\"flex\",\"orientation\":\"vertical\"}} -->\n<div class=\"wp-block-group alignfull\" style=\"gap:16px\">\n<!-- wp:shortcode -->[beats_cltd_visualizer]<!-- /wp:shortcode -->\n<!-- wp:shortcode -->[beats_cltd_display_home]<!-- /wp:shortcode -->\n<!-- wp:shortcode -->[beats_cltd_global_player]<!-- /wp:shortcode -->\n</div>\n<!-- /wp:group -->\n</div>\n<!-- /wp:group -->\n</main>\n<!-- /wp:group -->\nHTML;\n\n$page_args = array(\n    'post_title'   => 'Beats Demo',\n    'post_name'    => 'beats-demo',\n    'post_status'  => 'publish',\n    'post_type'    => 'page',\n    'post_content' => $beats_content,\n    'post_author'  => get_current_user_id() ?: 1\n);\n\n$existing_page = get_page_by_path( 'beats-demo' );\nif ( $existing_page ) {\n    $page_args['ID'] = $existing_page->ID;\n    $page_id         = wp_update_post( $page_args );\n    error_log('[Beats Blueprint] updated existing Beats Demo page ID ' . $existing_page->ID);\n} else {\n    $page_id = wp_insert_post( $page_args );\n    error_log('[Beats Blueprint] inserted Beats Demo page ID ' . $page_id);\n}\n\nif ( ! is_wp_error( $page_id ) ) {\n    update_option( 'show_on_front', 'page' );\n    update_option( 'page_on_front', $page_id );\n    update_option( 'page_for_posts', 0 );\n    error_log('[Beats Blueprint] show_on_front after: ' . var_export(get_option('show_on_front', 'unset'), true));\n    error_log('[Beats Blueprint] page_on_front after: ' . var_export(get_option('page_on_front', 'unset'), true));\n    error_log('[Beats Blueprint] page_for_posts after: ' . var_export(get_option('page_for_posts', 'unset'), true));\n    error_log('[Beats Blueprint] Beats Demo permalink: ' . get_permalink( $page_id ));\n\n    flush_rewrite_rules( true );\n    error_log('[Beats Blueprint] rewrite rules flushed');\n\n    $refresh_url = add_query_arg( 'refresh', time(), home_url( '/' ) );\n    error_log('[Beats Blueprint] refresh url: ' . $refresh_url);\n    $response = wp_remote_get( $refresh_url );\n    if ( is_wp_error( $response ) ) {\n        error_log('[Beats Blueprint] refresh request failed: ' . $response->get_error_message());\n    } else {\n        error_log('[Beats Blueprint] refresh response code: ' . wp_remote_retrieve_response_code( $response ));\n    }\n\n    echo 'Beats Demo front page ready (post ID ' . $page_id . ').' . PHP_EOL;\n} else {\n    error_log('[Beats Blueprint] failed to create Beats Demo page: ' . $page_id->get_error_message());\n    echo 'Failed to create Beats Demo page: ' . $page_id->get_error_message() . PHP_EOL;\n}\n\n$upload_content = <<<HTML\n<!-- wp:group {\"tagName\":\"main\",\"align\":\"full\",\"style\":{\"spacing\":{\"padding\":{\"top\":\"30px\",\"right\":\"20px\",\"bottom\":\"40px\",\"left\":\"20px\"}}}} -->\n<main class=\"wp-block-group alignfull\" style=\"padding-top:30px;padding-right:20px;padding-bottom:40px;padding-left:20px\">\n<!-- wp:group {\"align\":\"full\",\"style\":{\"spacing\":{\"blockGap\":\"18px\",\"margin\":{\"top\":\"0\",\"bottom\":\"0\"},\"padding\":{\"top\":\"24px\",\"right\":\"24px\",\"bottom\":\"24px\",\"left\":\"24px\"}},\"border\":{\"radius\":\"16px\"}},\"layout\":{\"type\":\"constrained\"}} -->\n<div class=\"wp-block-group alignfull\" style=\"border:none;border-radius:16px;margin-top:0;margin-bottom:0;padding-top:24px;padding-right:24px;padding-bottom:24px;padding-left:24px\">\n<!-- wp:heading {\"textAlign\":\"center\"} -->\n<h2 class=\"wp-block-heading has-text-align-center\">Upload</h2>\n<!-- /wp:heading -->\n<!-- wp:paragraph {\"align\":\"center\"} -->\n<p class=\"has-text-align-center\">Share a new beat with the Playground uploader.</p>\n<!-- /wp:paragraph -->\n<!-- wp:shortcode -->[beats_cltd_upload_form]<!-- /wp:shortcode -->\n</div>\n<!-- /wp:group -->\n</main>\n<!-- /wp:group -->\nHTML;\n\n$upload_args = array(\n    'post_title'   => 'Upload',\n    'post_name'    => 'upload',\n    'post_status'  => 'publish',\n    'post_type'    => 'page',\n    'post_content' => $upload_content,\n    'post_author'  => get_current_user_id() ?: 1\n);\n\n$upload_page = get_page_by_path( 'upload' );\nif ( ! $upload_page ) {\n    $sample_page = get_page_by_path( 'sample-page' );\n    if ( $sample_page ) {\n        $upload_args['ID'] = $sample_page->ID;\n        $upload_id         = wp_update_post( $upload_args );\n        error_log('[Beats Blueprint] repurposed Sample Page as Upload page ID ' . $sample_page->ID);\n    } else {\n        $upload_id = wp_insert_post( $upload_args );\n        error_log('[Beats Blueprint] inserted Upload page ID ' . $upload_id);\n    }\n} else {\n    $upload_args['ID'] = $upload_page->ID;\n    $upload_id         = wp_update_post( $upload_args );\n    error_log('[Beats Blueprint] updated existing Upload page ID ' . $upload_page->ID);\n}\n\nif ( is_wp_error( $upload_id ) ) {\n    error_log('[Beats Blueprint] Failed to prepare Upload page: ' . $upload_id->get_error_message());\n} else {\n    error_log('[Beats Blueprint] Upload page ready (post ID ' . $upload_id . ').');\n}\n\nadd_filter( 'render_block_core/navigation', function( $block_content, $block ) {\n    return beats_filter_navigation_html( $block_content );\n}, 10, 2 );\n\nadd_filter( 'render_block_core/post-title', function( $block_content, $block ) {\n    if ( is_front_page() ) {\n        return '';\n    }\n\n    return $block_content;\n}, 10, 2 );\n\nadd_filter( 'render_block_core/site-title', function( $block_content, $block ) {\n    $title = esc_html( get_option( 'blogname', 'Beats' ) );\n    $pattern = '/(<a[^>]*wp-block-site-title__link[^>]*>)(.*?)(<\\/a>)/is';\n    if ( preg_match( $pattern, $block_content ) ) {\n        return preg_replace( $pattern, '$1' . $title . '$3', $block_content );\n    }\n\n    $pattern = '/(<[^>]*wp-block-site-title[^>]*>)(.*?)(<\\/[^>]+>)/is';\n    if ( preg_match( $pattern, $block_content ) ) {\n        return preg_replace( $pattern, '$1' . $title . '$3', $block_content );\n    }\n\n    return $block_content;\n}, 10, 2 );\n\nadd_action( 'wp_head', function() {\n    echo '<style>#beats-wrapper{border:none!important;box-shadow:none!important;}#beats-wrapper .wp-block-group{border:none!important;box-shadow:none!important;}</style>';\n} );\n\nerror_log('[Beats Blueprint] runPHP complete');\n\nupdate_option( 'blogname', 'Beats' );\n$wp_navigation = get_posts( [ 'post_type' => 'wp_navigation', 'numberposts' => 1 ] );\nif ( ! empty( $wp_navigation ) ) {\n    $nav = $wp_navigation[0];\n    $blocks = parse_blocks( $nav->post_content );\n    $filtered = array_filter(\n        $blocks,\n        function( $block ) {\n            if ( 'core/navigation-link' !== ( $block['blockName'] ?? '' ) ) {\n                return true;\n            }\n            $label = trim( $block['attrs']['label'] ?? '' );\n            return strtolower( $label ) !== 'beats demo';\n        }\n    );\n    if ( count( $filtered ) !== count( $blocks ) ) {\n        $nav->post_content = serialize_blocks( $filtered );\n        wp_update_post( $nav );\n        error_log( '[Beats Blueprint] Navigation cleaned.' );\n    }\n}\n"
    }
  ]
}